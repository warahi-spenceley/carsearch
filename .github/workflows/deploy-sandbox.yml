# The purpose of a deployment to a sandbox environment is so other developers can run test cases for new feature or bug fix using the same Docker image as production before deploying to the production environment.
name: Deployment to AWS EBS Sandbox environment

on:
  pull_request:
    branches: 
      - develop
    types: [closed]

jobs:
  deploy:
    run_if:
      if: ${{ github.event.pull_request.merged }}
        # Specify the operating system to run on
        runs-on: ubuntu-latest
        steps:
          # Check out to the code
          - name: Checkout Latest Repo
            uses: actions/checkout@master
            
          # Package all of the code into a zip file, except the node_modules folder.
          - name: Generate Deployment Package 
            run: zip -r deploy.zip * -x "**node_modules**"

          # Generate a formated current timestamp to use as the version label in this case.
          - name: Get timestamp
            uses: gerred/actions/current-time@master
            id: current-time

          - name: Run string replace
            uses: frabert/replace-string-action@master
            id: format-time
            with:
              pattern: '[:\.]+'
              string: "${{ steps.current-time.outputs.time }}"
              replace-with: '-'
              flags: 'g'

          # Push the zip file which contains the docker-compose file over to AWS Elastic Beanstalk.
          - name: Deploy to AWS EBS
            uses: einaregilsson/beanstalk-deploy@v14
            with:
              aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
              aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
              application_name: carsearch
              environment_name: carsearch-sandbox
              version_label: "carsearch-deployment-${{ steps.format-time.outputs.replaced }}"
              region: ap-southeast-2
              deployment_package: deploy.zip
